---
    title: "From Local Structure to Cultural Networks"
    author: "Omar Lizardo"
    date: "`r Sys.Date()`"
---

# Setup
```{r setup}
   knitr::opts_chunk$set(include=FALSE, echo = TRUE, warning = FALSE, message = FALSE)
   library(conflicted)
   library(ergm)
   library(here)   
   library(haven)
   library(dplyr)
   library(sjPlot)
```

# Data Wrangling
```{r Importing and creating two mode data frame of people by genres}
    taste.dat <- read_dta("C:/Users/Omar Lizardo/Google Drive/MISC DATA SOURCES/SSI-2012/SSI2012.dta")
    taste.dat <- taste.dat %>% 
      dplyr::select("id", ends_with(c("lis", "like")), -starts_with("none")) %>% 
      dplyr::select(c(1:41)) %>% 
      na.omit() %>% 
      mutate(Classical = classicallike * classicallis,
             Opera = operalike * operalis,
             Jazz = jazzlike * jazzlis,
             Broadway = bwaystlike * bwaystlis,
             Easy = moodezlike * moodezlis, 
             Bigband = bbandlike * bbandlis,
             Classic_Rock = croldlike * croldlis,
             Country = countrylike * countrylis,
             Bluegrass = blueglike * blueglis,
             Folk = folklike * folklis,
             Gospel = hymgoslike * hymgoslis,
             Salsa = latlpsallike * latspsallis,
             Rap_Hip_Hop = raphiphoplike * raphiphoplis,
             Blues_RandB = blurblike * blurblis,
             Reggae = reggaelike * reggaelis,
             Pop = toppoplike * toppoplis,
             Contemp_Rock = controcklike * controcklis,
             Indie_Alt = indaltlike * indaltlis,
             Dance_Club = danclublike * danclublis,
             Metal = hvymtllike * hvymtllis
             ) %>%  #people are linked to genres that the both like and listen to
      dplyr::select(id, Classical:Metal) %>% 
      rowwise() %>% 
      mutate(deg = sum(c_across(2:21))) %>% 
      ungroup() %>% 
      dplyr::filter(deg > 0 & deg < 20) 
```

```{r}
   source(here("Functions", "demog.dat.R"))
   dat.demog <- demog.dat() %>% 
      dplyr::filter(id %in% unlist(taste.dat$id))  %>% 
      dplyr::select(c("id", "age", "educ.f", "gender")) %>% 
      mutate(across(age:gender, as.character)) %>% 
      dplyr::slice(-which(is.na(age))) %>% 
      mutate(type = NA)
   taste.mat <- as.matrix(dplyr::filter(taste.dat, id %in% dat.demog$id)[2:21])
   rownames(taste.mat) <- dat.demog$id
   dat.demog <- dat.demog[-1]
   #genre data
   genre.dat <- data.frame(matrix(nrow = 20, ncol = 0))
   rownames(genre.dat) <- names(taste.dat[,2:21])
   genre.dat$age <- NA
   genre.dat$educ.f <- NA
   genre.dat$gender <- NA
   genre.dat$type <- c(rep("high", 6), rep("folk", 5), rep("blkpop", 4), rep("pop", 5))
   genre.dat
   dat.demog <- rbind(dat.demog, genre.dat)
   attribute_list <- do.call(list, dat.demog)
   #network object
   taste.net <- network(taste.mat, bipartite = TRUE, vertex.attr = attribute_list)
```
   



```{r}
   m1 <- ergm(taste.net ~ edges)
   m2 <- ergm(taste.net ~ edges + 
                 b2factor("type", levels = -4))
   m3 <- ergm(taste.net ~ edges + 
                 b2factor("type", levels = -4) + 
                 b1factor("educ.f", levels = c(4, 2, 7, 3, 6, 5)) +
                 b1factor("age", levels = -4) +
                 b1factor("gender") 
                 )
   m4 <- ergm(taste.net ~ edges + 
                 b2factor("type", levels = -4) + 
                 b1factor("educ.f", levels = c(4, 2, 7, 3, 6, 5)) +
                 b1factor("age", levels = -4) +
                 b1factor("gender") +
                 b2nodematch("type", beta = .25)
                 )
   summary(m4)
```

